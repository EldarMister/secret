# Изменения в версии 2.0

## Обзор

Проект "Бизнес Жардамчы ГО" полностью переработан согласно новому техническому заданию.

## Ключевые изменения

### 1. База данных

**Было:** Google Sheets  
**Стало:** PostgreSQL

**Причина:** Более надежное хранение данных, транзакции, сложные запросы

**Новые таблицы:**
- `users` - пользователи WhatsApp
- `orders` - заказы с расширенными полями
- `drivers` - водители с балансом
- `cafes` - кафе с долгом
- `pharmacies` - аптеки
- `shoppers` - закупщики
- `transactions` - логи всех операций
- `auction_timers` - таймеры аукционов
- `pharmacy_bids` - ценовые предложения

### 2. WhatsApp API

**Было:** Только GREEN API  
**Стало:** GREEN API + Twilio

**Причина:** Гибкость выбора провайдера

```python
WHATSAPP_PROVIDER=green  # или "twilio"
```

### 3. Финансовая система

#### Баланс водителей
```python
# Проверка перед взятием заказа
if not db.can_driver_take_order(driver_id):
    return "Недостаточно средств"

# Списание комиссии
success, new_balance = db.update_driver_balance(
    driver_id, 
    -config.TAXI_COMMISSION,
    reason=f"Order {order_id}"
)
```

#### Долг кафе
```python
# Добавление комиссии в долг
commission_added, new_debt = db.update_cafe_debt(
    cafe_id, 
    order_amount
)
```

#### Режим Рамазан
```python
IS_RAMADAN = true  # Глобальный переключатель

if config.IS_RAMADAN:
    taxi_commission = 0
    cafe_discount = "Скидка от сервиса"
```

### 4. Аукционы и таймеры

#### Кафе (2 минуты)
```
Заказ отправлен → Таймер 2 мин → Если нет ответа → СРОЧНЫЙ ЗАКАЗ!
```

#### Такси (1 минута)
```
Заявка в группу → Таймер 1 мин → Если нет ответа → Повышенный приоритет
```

#### Аптека (3 минуты)
```
Запрос в группу → Таймер 3 мин → Напоминание
```

### 5. Потоки данных

#### Кафе (полный цикл)
```
1. Клиент: Заказ → Адрес → Оплата
2. Бот: Создает заказ → Отправляет в группу кафе (таймер 2 мин)
3. Кафе: Нажимает "Принять" → Указывает время готовности
4. Бот: 
   - Обновляет долг кафе (+5%)
   - Отправляет заявку в группу такси
   - Уведомляет клиента
5. Таксист: Берет заказ → Баланс -10 сом
6. Бот: Отправляет клиенту данные водителя
```

#### Магазин (с вариантами доставки)
```
1. Клиент: Список продуктов
2. Бот: Просит подтверждение (200 сом)
3. Клиент: Подтверждает
4. Бот: Отправляет закупщику
5. Закупщик: Берет заказ → Выбирает:
   
   Вариант А: "Доставлю сам"
   - Закупщик забирает 200 сом
   
   Вариант Б: "Вызвать такси"
   - Закупщик забирает 100 сом
   - Таксист забирает 100 сом
   - Клиент платит чек + 200 сом
```

#### Аптека (с подтверждением цены)
```
1. Клиент: Название лекарства / Фото рецепта
2. Бот: Отправляет в группу аптек
3. Аптека: Указывает цену (например, 450 сом)
4. Бот: Спрашивает клиента:
   "Цена 450 сом + доставка 100 сом = 550 сом. Берем?"
5. Клиент: Подтверждает
6. Бот: Отправляет заявку в группу такси
   "Надо выкупить 450 сом, с клиента 550 сом"
```

### 6. Администрирование

#### Новые endpoints

**Водители:**
```
GET    /admin/drivers          # Список
POST   /admin/drivers          # Добавить
DELETE /admin/drivers/<id>     # Удалить
POST   /admin/drivers/<id>/balance  # Изменить баланс
```

**Кафе:**
```
GET    /admin/cafes            # Список
POST   /admin/cafes            # Добавить
GET    /admin/cafes/<id>/debt  # Долг
```

**Рассылка:**
```
POST   /admin/broadcast        # Рассылка сообщений
```

**Статистика:**
```
GET    /admin/stats            # Статистика
GET    /admin/transactions     # Транзакции
GET    /admin/settings         # Настройки
POST   /admin/settings/ramadan # Переключить Рамазан
```

### 7. State Machine (расширенная)

```
IDLE
├── CAFE_ORDER → CAFE_ADDRESS → CAFE_PAYMENT → (аукцион)
├── SHOP_LIST → SHOP_CONFIRM → (закупщику)
├── PHARMACY_WAIT_RX → (аукцион) → PHARMACY_CONFIRM
├── TAXI_ROUTE → (аукцион)
└── PORTER_CARGO_TYPE → PORTER_ROUTE → (группа)
```

### 8. Поддержка языков

**Русский / Кыргызский (смешанный)**

Пример сообщения:
```
Ассаламу алейкум! Мен Жардамчы ГО - сиздин жардамчыңыз!
Здравствуйте! Я Жардамчы ГО - ваш помощник!
```

### 9. Комиссии (итоговая таблица)

| Услуга | Комиссия | Рамазан |
|--------|----------|---------|
| Кафе | 5% | Скидка клиенту |
| Магазин | 200 сом | Без изменений |
| Аптека | 5% | Без изменений |
| Такси | 10 сом | 0 сом |
| Портер | 20 сом | Без изменений |

### 10. Новые константы

```python
# config.py

# Таймауты
CAFE_AUCTION_TIMEOUT = 120      # 2 минуты
PHARMACY_RESPONSE_TIMEOUT = 180 # 3 минуты
TAXI_RESPONSE_TIMEOUT = 60      # 1 минута

# Комиссии
CAFE_COMMISSION_PERCENT = 5
TAXI_COMMISSION = 10
PORTER_COMMISSION = 20
SHOPPER_SERVICE_FEE = 200
PHARMACY_DELIVERY_FEE = 100

# Лимиты
MIN_DRIVER_BALANCE = -100
MAX_CAFE_DEBT = 10000
```

## Файлы проекта

```
business-assistant-go/
├── src/
│   ├── app.py                    # Flask Application Factory
│   ├── config.py                 # Конфигурация (обновлена)
│   ├── main.py                   # WhatsApp webhook (обновлен)
│   ├── telegram_handler.py       # Telegram callback (обновлен)
│   ├── client_confirm_handler.py # Подтверждения (обновлен)
│   ├── services.py               # API интеграции (обновлен)
│   ├── db.py                     # PostgreSQL (новый)
│   ├── cron_jobs.py              # Таймеры (обновлен)
│   └── admin.py                  # Администрирование (новый)
├── logs/
├── .env.example                  # Переменные окружения (обновлен)
├── requirements.txt              # Зависимости (обновлен)
├── README.md                     # Документация (обновлен)
├── deploy.sh                     # Деплой
├── setup_cron.sh                 # Cron задачи
└── business-assistant.service    # Systemd сервис
```

## Миграция с v1.0

1. Экспортируйте данные из Google Sheets
2. Настройте PostgreSQL
3. Обновите `.env` файл
4. Запустите приложение (таблицы создадутся автоматически)
5. Импортируйте данные

## Быстрый старт

```bash
# 1. Клонирование
git clone <repo>
cd business-assistant-go

# 2. Виртуальное окружение
python3.12 -m venv venv
source venv/bin/activate

# 3. Зависимости
pip install -r requirements.txt

# 4. База данных
createdb business_assistant

# 5. Конфигурация
cp .env.example .env
# Отредактируйте .env

# 6. Запуск
python src/app.py
```

## Проверка работоспособности

```bash
# Health check
curl http://localhost:5000/health

# Статистика (админ)
curl -H "X-Admin-Id: YOUR_ID" http://localhost:5000/admin/stats
```
